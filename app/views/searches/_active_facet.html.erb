<% facet_dom_id = "selected_#{active_facet}" %>
<% query = query.to_a unless query.is_a?(Array) %>
<div id="<%= facet_dom_id %>" class="active-facet">
  <span class="facet-name"><%= t(active_facet.singularize) %>:</span>

  <% is_category = Category.is_category?(active_facet) %>

  <ul>
  <% if is_category %>

    <% query = query.map{|c| c.to_i != 0 ? Category.find(c) : nil }.compact %>

    <% query.each_with_index do |category, index| %>
        <%# translate language parts individually %>
        <% category_titles = category.is_a?(String) ? [ category ] : (active_facet == 'languages' ? category.name.split('/') : [ category.name ]) %>
        <%# don't translate country names #%>
        <% category_titles = category_titles.map{|ct| t(ct, :scope => "categories.#{active_facet}")} unless active_facet == 'countries' %>
    <li><%= category_titles.join('/') -%><%= (index == query.size-1) ? '' : ','-%></li>
    <% end %>

  <% else %>
    <% query.split(' ').each do |name_token| %>
    <li><%= name_token %></li>
    <% end %>
  <% end %>
  </ul>


  <%= link_to_function 'entfernen', :class=>'facet-remove', :title => 'entfernen' do |page|
      page[facet_dom_id].visual_effect :switch_off
      if is_category
        query.each do |category|
          next unless category.is_a?(Category)
          page << "Element.remove('#{active_facet + '_' + category[:id].to_s}');"
          # NOTE: the reinstate feature was removed because the
          # non-reinstating behaviour (i.e. where the removed facets are not
          # added back in as checked categories) is more consistent overall.
          # page << "$('search_facets').insert(new Element('input', { type: 'hidden', name: 'reinstate[]', value: '#{active_facet + '_' + category[:id].to_s}' }));"
        end
      else
        page << "Element.remove('#{active_facet.singularize}');";
      end
      page << "submitViaAjax();"
  end %>

  <fieldset style="display:none" id="<%= active_facet %>_query" class="facet-field">

    <% if is_category %>

      <%# javascript_tag do %>
        <%# query.select{|c| c.to_i != 0}.each do |category| %>
          <%# checkedCategories.push('<%= active_facet.singularize + '_' + category.to_s %>'); %>
        <%# end %>
      <%# end %>

      <% query.each do |category| %>
        <%= hidden_field_tag "#{active_facet}[]", category[:id], { :id => "#{active_facet}_#{category[:id]}"} %>
      <% end %>

    <% else %>

      <%= hidden_field_tag "#{active_facet}", query, :id => "#{active_facet.singularize}" %>
    
    <% end %>

  </fieldset>
</div>