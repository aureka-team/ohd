<% facet_id = facet_option.first.to_sym %>
<% facet_name = facet_id.to_s %>
<% facet_entries = facet_option.last %>
<% category_facet = CeDiS.is_category?(facet_id) %>
<% human_readable_facet_name = (category_facet ? CeDiS.category_name(facet_id, I18n.locale) : t(facet_name.singularize, :scope => :facets)) %>
<% item_list = !category_facet && (facet_entries.size < 13) %>
<% facet_closed = ((search_facets.object.send(facet_id) || []).empty? and search_facets.object.open_category != facet_name) %>

  <div id="<%= facet_name %>" class="fragmentTitle <%= facet_closed ? 'closed' : 'open'%>">

    <% if category_facet && facet_entries.empty? %>

      <h2 class='more disabled'>
        <img title="" src="<%= image_path 'pfeil_rot_rechts.gif' %>" id="<%= facet_name %>_query_closed" alt="<%= t('.arrow_right') %>" />
        <%= human_readable_facet_name %>
      </h2>

    <% else %>

      <h2 onclick="toggleCategory('<%= facet_name %>_query', <%= category_facet || item_list %>);" class="more <%= (category_facet && facet_entries.empty?) ? 'disabled' : '' %>">
        <img title="" src="<%= image_path 'pfeil_rot_rechts.gif' %>" id="<%= facet_name %>_query_closed" class="arrow-closed" alt="<%= t('.arrow_right') %>" />
        <img title="" src="<%= image_path 'pfeil_rot_unten.gif' %>" id="<%= facet_name %>_query_open" class="arrow-open" alt="<%= t('.arrow_down') %>" />
        <%= human_readable_facet_name %>
        <%= search_facets.submit '&uuml;bernehmen', :style => 'display: none;', :type => 'image', :src => image_path('suchpfeil_quad_grau.gif'), :title => t('.update'), :class => 'facet_refresh', :id => "#{facet_name}_submit", :onclick => "submitViaAjax();false;" %>
      </h2>
      <fieldset style="<%= facet_closed ? 'display: none;' : ''%>" id="<%= facet_name %>_query" class="facet-field">

          <% if category_facet or facet_id == :language_id %>

            <% current_categories = search_facets.object.send(facet_id) || [] %>

            <ul>
              <% facet_entries.each do |f| %>

                <% category = f.first %>

                <li class="facet<%= current_categories.include?(category[:id]) ? ' checked' : '' %>" onclick="checkCategory('<%= "#{facet_name}_#{category[:id]}" %>', this);" id="<%= "facet_#{facet_name}_#{category[:id]}" -%>">
                    <%= check_box_tag "#{facet_name}[]", category[:id], current_categories.include?(category[:id]), { :id => "#{facet_name}_#{category[:id]}", :class => (facet_name + ' checkbox') } %>
                    <span class="facet-name"><%= category.to_s %></span>
                    <% if f.last != 0 %>
                      <span class="facet-count">(<%= f.last %>)</span>
                    <% end %>
                </li>

              <% end %>
            </ul>

          <% elsif facet_id == :interview_id %>

            <% if item_list and !facet_entries.empty? %>

              <ul>
                <% facet_entries.each do |name| %>
                  <li><%= link_to_remote name.first.full_title(I18n.locale), :url => url_for(:controller => :searches, :action => :new, :interview_id => [name.first.id] ), :method => :get %></li>
                <% end %>
              </ul>

            <% else %>

              <%= search_facets.text_field :person_name, { :size => 25, :name => 'person_name', :class => 'searchInput' } %>
              <div id="empty-message"></div>

              <% javascript_tag do %>
                jQuery('#search_person_name').autocomplete({
                  source: '<%= person_name_searches_path @search.query_params.reject{|k,v| k == 'page'} -%>',
                  minLength: 2,
                  select: function( event, ui ) {
                    // asynchronously submit the form - this is necessary
                    // for the form input to transfer the assigned value
                    // when clicking on it.
                    $this = jQuery(this)
                    setTimeout( function() { $this.closest('form').submit(); }, 0 );
                  },
                  response: function(event, ui) {
                    if (ui.content.length === 0) {
                      jQuery("#empty-message").text('<%=t '.no_persons_found' %>');
                    } else {
                      if (ui.content.length === 1 && ui.content[0]['label'] === 'redirect_to') {
                        // This is a special redirect message after an unauthorized access.
                        window.location.href = ui.content[0]['value']
                        // Remove the fake message to avoid it being temporarily shown to the user.
                        ui.content.pop()
                      } else {
                        // We got a normal result list.
                        jQuery("#empty-message").empty();
                      }
                    }
                  }
                });
              <% end %>

            <% end %>

          <% end %>
      </fieldset>

    <% end %>

  </div>
