<div class="baseListBox">

  <% javascript_tag do %>
    var checkedCategories = [];
  <% end %>

  <% remote_form_for facets,
                     :url => new_search_path,
                     :method => :get,
                     :before => 'applyFulltext();',
                     :html => { :action => new_search_path,
                                :method => :get,
                                :name => "searchFacets",
                                :id => "search_facets" } do |search_facets| %>

    <div class="fragmentTitle">
        <span class="searchString">Suchbegriff (Volltextsuche)</span>
        <%= search_facets.text_field :fulltext, :size => 30, :id => 'searchInput', :class => 'baseInputSearch', :title => 'Suchbegriff bitte hier eingeben' %>
    </div>

    <noscript>
      <div class="warning">
        <h4>Bitte aktivieren Sie Javascript, um die interaktive Suche zu nutzen.</h4>
      </div>
    </noscript>

    <% facets.query_facets.each do |facet| %>
    <%= render :partial => '/searches/active_facet', :object => facet.first, :locals => { :query => facet.last } %>
    <% end %>

    <% facets.unqueried_facets.each do |facet| %>
    <%= render :partial => '/searches/facet_option', :object => facet, :locals => { :search_facets => search_facets, :category_facet => facets.send(facet.first).is_a?(Array)} %>
    <% end %>

    <fieldset style="display:none">
      <%= search_facets.hidden_field :fulltext, :id => 'search_facets_fulltext' %>
    </fieldset>

  <% end %>

    <% javascript_tag do %>

        var categoryElems = $$('fieldset.facet-field');

        // apply the facet parameters to the fulltext search
        function applyFacets() {
          for(var cat=0; cat < categoryElems.length; cat++) {
            var id = categoryElems[cat].id.sub(/_query$/,'');
            if(id == 'person_name') {
                $('search_form_person_name').value = $('person_name_query').value;
            } else {
                var categories = $$('.' + id);
                // delete the existing search form elems
                $$('#search_form .' + id).each(function(el) { el.remove(); });
                // copy the checked elems over to the search form as hidden fields
                $$('.' + id).each(function(el) {
                    if(el.checked) {
                        var elemName = 'search['+id+'][]';
                        var hiddenElem = new Element('input', { type: 'hidden', name: elemName, value: el.value, class: id });
                        $('search_form').insert(hiddenElem);
                    }
                });
            }
          }
        };

        // apply the fulltext parameter to the facets search
        function applyFulltext() {
          $('search_facets_fulltext').value = $('searchInput').value;
        };

        // blind effect for category facets
        var blindStatus = new Array(categoryElems.length);
        function toggleCategory(id) {
          var cat_index = -1;
          for(var i=0; i< categoryElems.length; i++) {
            if (id == categoryElems[i].id) {
                cat_index = i;
            }
          }
          if(cat_index > -1) {
            if(blindStatus[cat_index] != 1) {
                Effect.BlindDown(id, { duration: 0.4, transition: Effect.Transitions.sinoidal });
                blindStatus[cat_index] = 1;
            } else {
                Effect.BlindUp(id, { duration: 0.4, transition: Effect.Transitions.sinoidal });
                blindStatus[cat_index] = 0;
            }
            Element.toggle(id + '_closed');
            Element.toggle(id + '_open');
          }
        };

        function categoryState(id, state) {
            var checkbox = $(id);
            if(checkbox) {
                checkbox.checked = state;
            }
        };

        checkedCategories.each(function(id) {
            categoryState(id, true);
        });

    <% end %>

</div>