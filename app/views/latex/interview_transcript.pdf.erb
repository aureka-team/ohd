<% interviewee_first_name = "#{@interview.interviewees.first.translations.where(locale: @language[:locale]).first.first_name}" %>
<% interviewee_last_name = "#{@interview.interviewees.first.translations.where(locale: @language[:locale]).first.last_name}" %>
<% interviewee_name = "#{interviewee_first_name} #{interviewee_last_name}" %>

\title{<%= interviewee_name %>}
\date{}

\begin{document}
\maketitle
\thispagestyle{fancy}

\fancyhead{}
\fancyfoot{}
<% translation = @language[:type] == 'translation' ? "(#{I18n.backend.translate(@language[:locale][0..1], 'translation')}) " : "" %>
\lhead{<%= latex_escape("#{I18n.backend.translate(@language[:locale][0..1], 'transcript')} #{translation}#{interviewee_name} (#{@interview.archive_id})") %>}
\rfoot{\thepage}

<% paragraphs = [] %>
<% last_speaker_id = 0 %>
<% new_line = false %>
<% @interview.segments.select {|i| i.tape.number == 1}.each_with_index do |segment, index| %>
  <% if (segment.speaker_changed && !segment.speaker_id.nil? && segment.speaker_id > 0) || (!segment.speaker_id.nil? && segment.speaker_id > 0 && segment.speaker_id != last_speaker_id) %>
    <% last_speaker_id = segment.speaker_id if segment.speaker_id > 0 %>
    <% new_line = true %>
    <% person_translation = Person.find(segment.speaker_id).translations.where(locale: @language[:locale]).first %>
    <% speaker = "#{person_translation.first_name} #{person_translation.last_name}".strip %>
    <% sentence = latex_escape(speaker  + ": " + segment.send(@language[:type].to_sym).sub(/^\:{1}\s*\:*/, "")) %>
  <% else %>
    <% new_line = false %>
    <% sentence = latex_escape(segment.send(@language[:type].to_sym)) %>
  <% end %>
  <% paragraph_hash = Hash.new %>
  <% paragraph_hash['segment'] = sentence %>
  <% paragraph_hash['new_line'] = new_line %>
  <% paragraphs << paragraph_hash %>
  <% if !segment.mainheading(@language[:locale]).blank? || !segment.subheading(@language[:locale]).blank? || index == @interview.segments.count - 1 %>
    <% paragraphs.each do |paragraph| %>
      <% if paragraph['new_line'] %>
        <%= "" %>
      <% end %>
      <%= paragraph['segment'] %>
    <% end %>
    <% unless segment.mainheading(@language[:locale]).blank? %>
      \section{  <%= latex_escape(segment.mainheading(@language[:locale])) %>}
    <% end %>
    <% unless segment.subheading(@language[:locale]).blank? %>
      \subsection{ <%= latex_escape(segment.subheading(@language[:locale])) %>}
    <% end %>
    <% paragraphs = [] if index != @interview.segments.count - 1 %>
  <% end %>
<% end %>




